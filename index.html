<script>
  // ===== POSTAVKE =====
  const PASS_THRESHOLD = 120;

  const ranges = [
    { min: 151, max: 220, label: "151–220: vrlo dobra kompatibilnost", rec: "Preporuka: uključivanje uz mentorstvo i konkretne korake." },
    { min: 81,  max: 150, label: "81–150: potencijal postoji",       rec: "Preporuka: sporiji tempo, jasna očekivanja, dogovor oko plana." },
    { min: 0,   max: 80,  label: "0–80: trenutno nezrelo",           rec: "Preporuka: edukacija i pauza; bez pritiska." }
  ];

  const titles = {
    q1: "MLM stav",
    q2: "Nagrade/prihodi ovise o",
    q3: "Vrijeme tjedno koje može izdvojiti",
    q4: "Učenje vještina",
    q5: "Dugoročni rezultati",
    q6: "Važnost jasnog objašnjenja",
    q7: "Spremnost na plan 30 dana",
    q8: "Razgovor s ljudima",
    q9: "Financijski okvir",
    i10: "Što dalje želi",
    i11: "Tombola / webinar",
    i12: "Preporuka druge osobe",
    i13: "Model gradnje tima"
  };

  // ===== DOM =====
  const quizForm = document.getElementById("quizForm");
  const resultCard = document.getElementById("resultCard");
  const mentorSummaryEl = document.getElementById("mentorSummary");
  const statusPill = document.getElementById("statusPill");

  const mentorIdEl = document.getElementById("mentorId");
  const mentorEmailEl = document.getElementById("mentorEmail");
  const mentorPhoneEl = document.getElementById("mentorPhone");
  const candidateNameEl = document.getElementById("candidateName");
  const candidateNoteEl = document.getElementById("candidateNote");
  const inviteLinkEl = document.getElementById("inviteLink");

  const scoreLine = document.getElementById("scoreLine");
  const rangeLine = document.getElementById("rangeLine");
  const passLine  = document.getElementById("passLine");

  const btnReset = document.getElementById("btnReset");
  const btnCopy  = document.getElementById("btnCopy");
  const btnEmail = document.getElementById("btnEmail");
  const btnWA    = document.getElementById("btnWA");
  const btnTG    = document.getElementById("btnTG");

  // ===== HELPERS =====
  function safeText(v){ return (v ?? "").toString().trim(); }
  function candidateName(){ return safeText(candidateNameEl.value) || "Kandidat"; }

  function buildInviteLink(){
    const mentorId = safeText(mentorIdEl.value);
    if(!mentorId) return "";
    return `https://novalusprime.com/Invite/${encodeURIComponent(mentorId)}`;
  }

  function setInviteUI(){
    const url = buildInviteLink();
    if(url){
      inviteLinkEl.href = url;
      inviteLinkEl.textContent = url;
    }else{
      inviteLinkEl.href = "#";
      inviteLinkEl.textContent = "— (upiši Mentor ID gore)";
    }
  }

  function calcScore(){
    const fd = new FormData(quizForm);
    let sum = 0;
    for(let i=1;i<=9;i++){
      sum += Number(fd.get(`q${i}`) || 0);
    }
    return sum;
  }

  function getRange(score){
    let r = ranges.find(x => score >= x.min && score <= x.max);
    if(!r) r = ranges[ranges.length - 1];
    return r;
  }

  function pickChosenText(name){
    const checked = quizForm.querySelector(`input[name="${name}"]:checked`);
    if(!checked) return { text:"-", points:null };
    const opt = checked.closest(".opt");
    const text = opt?.querySelector(".label-text")?.textContent?.trim() || "-";
    const pts = opt?.dataset?.points ? Number(opt.dataset.points) : null;
    return { text, points: (Number.isFinite(pts) ? pts : null) };
  }

  function buildAnswersLines(){
    const lines = [];
    for(let i=1;i<=9;i++){
      const key = `q${i}`;
      const { text } = pickChosenText(key);
      lines.push(`${i}) ${titles[key]}: ${text}`);
    }

    const a10 = pickChosenText("i10").text;
    const a11 = pickChosenText("i11").text;
    const a12 = pickChosenText("i12").text;
    const a13 = pickChosenText("i13").text;

    const interest =
      `10) ${titles.i10}: ${a10}\n` +
      `11) ${titles.i11}: ${a11}\n` +
      `12) ${titles.i12}: ${a12}\n` +
      `13) ${titles.i13}: ${a13}`;

    return { scored: lines.join("\n"), interest };
  }

  function makeSummary(score){
    const mentorId = safeText(mentorIdEl.value) || "(nije upisan)";
    const mentorEmail = safeText(mentorEmailEl.value) || "(nije upisan)";
    const mentorPhone = safeText(mentorPhoneEl.value) || "(nije upisan)";
    const cand = candidateName();
    const note = safeText(candidateNoteEl.value) || "-";

    const r = getRange(score);
    const passed = score >= PASS_THRESHOLD;
    const invite = buildInviteLink() || "(upiši Mentor ID da se generira link)";

    const { scored, interest } = buildAnswersLines();

    return (
`NOVALUS PRIME – SAŽETAK UPITNIKA
Mentor ID: ${mentorId}
Mentor email: ${mentorEmail}
Mentor telefon: ${mentorPhone}

Kandidat: ${cand}

Bodovi: ${score}
Procjena: ${r.label}
Preporuka: ${r.rec}

ODGOVORI (1–9):
${scored}

INTERES (bez bodova):
${interest}

Napomena kandidata:
${note}

Invite link (ako kandidat želi): ${invite}
${passed ? "" : "\nStatus: Kandidat trenutno ne prelazi bodovni prag – preporuka bez pritiska."}
`);
  }

  function paintShareButtons(score){
    const passed = score >= PASS_THRESHOLD;
    const cls = passed ? "btn-gold" : "btn-green";
    [btnEmail, btnWA, btnTG].forEach(b=>{
      b.classList.remove("btn-ghost","btn-gold","btn-green");
      b.classList.add(cls);
    });
  }

  function setStatus(text){
    statusPill.innerHTML = `<span class="dot"></span>${text}`;
  }

  function allRequiredAnswered(){
    // Ako browser već blokira submit zbog required, ovo je dodatno za status
    const required = quizForm.querySelectorAll("input[required]");
    for(const r of required){
      const name = r.name;
      if(!quizForm.querySelector(`input[name="${name}"]:checked`)) return false;
    }
    return true;
  }

  // ===== UI: 3D SELECTED + POINTS =====
  function updateGroupUI(groupEl){
    const opts = groupEl.querySelectorAll(".opt");
    opts.forEach(o=>{
      o.classList.remove("selected","pop");
      const ptsEl = o.querySelector(".points");
      if(ptsEl) ptsEl.textContent = "";
    });

    const checked = groupEl.querySelector('input[type="radio"]:checked');
    if(!checked) return;

    const opt = checked.closest(".opt");
    if(!opt) return;

    opt.classList.add("selected","pop");

    const pts = opt.dataset.points;
    const ptsEl = opt.querySelector(".points");
    if(ptsEl){
      if(pts !== undefined && pts !== null && pts !== ""){
        ptsEl.textContent = `${pts} bod`;
      }else{
        ptsEl.textContent = ""; // interes pitanja
      }
    }

    // makni "pop" nakon animacije
    setTimeout(()=>opt.classList.remove("pop"), 450);
  }

  function bindOptionsUI(){
    document.querySelectorAll(".opts").forEach(groupEl=>{
      groupEl.addEventListener("change", ()=>{
        updateGroupUI(groupEl);
        setInviteUI();
        setStatus(allRequiredAnswered() ? "Spreman za izračun" : "Spreman za ispunjavanje");
      });
      // inicijalno stanje (ako browser restore-a form state)
      updateGroupUI(groupEl);
    });
  }

  // ===== ACTIONS =====
  async function copySummary(){
    const text = mentorSummaryEl.innerText.trim();
    if(!text) return alert("Nema sažetka za kopiranje.");
    try{
      await navigator.clipboard.writeText(text);
      alert("Sažetak kopiran. Zalijepi u WhatsApp/Telegram/email.");
    }catch(e){
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      alert("Sažetak kopiran.");
    }
  }

  function sendEmail(){
    const to = safeText(mentorEmailEl.value);
    if(!to) return alert("Nije upisan email mentora.");
    const body = mentorSummaryEl.innerText.trim();
    if(!body) return alert("Nema sažetka za slanje.");

    const subject = `Novalus Prime – rezultat upitnika (${candidateName()})`;
    const mailto =
      `mailto:${encodeURIComponent(to)}?` +
      `subject=${encodeURIComponent(subject)}&` +
      `body=${encodeURIComponent(body)}`;

    window.location.href = mailto;
  }

  function sendWhatsApp(){
    const phone = safeText(mentorPhoneEl.value).replace(/\s+/g,"");
    if(!phone) return alert("Nije upisan telefon mentora.");
    const text = mentorSummaryEl.innerText.trim();
    if(!text) return alert("Nema sažetka za slanje.");

    // WhatsApp wa.me treba broj bez + i bez razmaka
    const digits = phone.replace(/[^\d]/g,"");
    if(!digits) return alert("Telefon nije u dobrom formatu. Upiši npr. +385...");

    const url = `https://wa.me/${digits}?text=${encodeURIComponent(text)}`;
    window.open(url, "_blank", "noopener,noreferrer");
  }

  function sendTelegram(){
    const text = mentorSummaryEl.innerText.trim();
    if(!text) return alert("Nema sažetka za slanje.");
    const url = `https://t.me/share/url?text=${encodeURIComponent(text)}`;
    window.open(url, "_blank", "noopener,noreferrer");
  }

  function doReset(){
    quizForm.reset();

    // makni selekcije i bodove u UI
    document.querySelectorAll(".opts").forEach(groupEl=>{
      groupEl.querySelectorAll(".opt").forEach(o=>{
        o.classList.remove("selected","pop");
        const ptsEl = o.querySelector(".points");
        if(ptsEl) ptsEl.textContent = "";
      });
    });

    mentorSummaryEl.textContent = "";
    resultCard.style.display = "none";
    setInviteUI();
    setStatus("Spreman za ispunjavanje");
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function onSubmit(e){
    e.preventDefault();

    // Browser već validira required, ali ako je nešto zaobiđeno:
    if(!allRequiredAnswered()){
      alert("Molim odgovori na sva obavezna pitanja (uključujući interes 10–13).");
      return;
    }

    const score = calcScore();
    const r = getRange(score);
    const passed = score >= PASS_THRESHOLD;

    scoreLine.textContent = `Ukupno bodova: ${score} (prag prolaza: ${PASS_THRESHOLD})`;
    rangeLine.textContent = `Procjena: ${r.label}`;
    passLine.textContent  = passed ? "Status: ✅ Prelazi bodovni prag" : "Status: ⚠️ Ne prelazi bodovni prag";

    setInviteUI();

    mentorSummaryEl.textContent = makeSummary(score);
    paintShareButtons(score);

    resultCard.style.display = "block";
    setStatus("Rezultat izračunat");
    resultCard.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  // ===== INIT =====
  function init(){
    setInviteUI();
    bindOptionsUI();

    mentorIdEl.addEventListener("input", setInviteUI);

    quizForm.addEventListener("submit", onSubmit);
    btnReset.addEventListener("click", doReset);

    btnCopy.addEventListener("click", copySummary);
    btnEmail.addEventListener("click", sendEmail);
    btnWA.addEventListener("click", sendWhatsApp);
    btnTG.addEventListener("click", sendTelegram);

    setStatus(allRequiredAnswered() ? "Spreman za izračun" : "Spreman za ispunjavanje");
  }

  init();
</script>
